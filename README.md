# BRO BOT

Um bot para Telegram desenvolvido para a comunidade GYM NATION de academia e fitness. O bot d√° boas-vindas aos novos membros, gerencia um sistema de check-in, responde a d√∫vidas sobre fitness, fornece mensagens motivacionais, e muito mais.

## Funcionalidades Principais

-   **Boas-vindas a Novos Membros:** Detec√ß√£o autom√°tica e mensagens de boas-vindas personalizadas.
-   **Sistema de Check-in:** Permite aos administradores definir mensagens de check-in e aos membros registrarem presen√ßa. Inclui ranking de check-ins.
-   **Assistente de D√∫vidas Fitness:** Responde a d√∫vidas sobre treino, nutri√ß√£o, suplementa√ß√£o, etc., quando mencionado. Inclui feedback e modo especialista.
-   **Comandos Diversos:** Inclui comandos para motiva√ß√£o, c√°lculo de macros, regras do grupo, e mais.
-   **Gerenciamento de Usu√°rios:** Sistema de administradores do bot e blacklist para usu√°rios.
-   **Mensagens Recorrentes:** Permite configurar o envio peri√≥dico de mensagens.
-   **Integra√ß√£o:** Utiliza MongoDB para armazenamento de dados e API da Anthropic para IA.
-   **Implanta√ß√£o:** Suporte a Docker para f√°cil configura√ß√£o.
-   **Controle de Acesso:** Restringe o uso da maioria dos comandos ao propriet√°rio e administradores designados.

## Requisitos

-   Python 3.8+
-   [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot) 20.7+
-   [python-dotenv](https://github.com/theskumar/python-dotenv) 1.0.0+
-   [motor](https://motor.readthedocs.io/en/stable/) 3.7.0+ (Cliente MongoDB ass√≠ncrono)
-   [pymongo](https://pymongo.readthedocs.io/en/stable/) 4.11.1+ (Usado para tipos de exce√ß√£o)
-   [anthropic](https://github.com/anthropics/anthropic-sdk-python) (SDK da Anthropic)
-   MongoDB (Local ou remoto)
-   Chave API da Anthropic
-   Token do Bot do Telegram

**Para desenvolvimento e testes:**

-   [pytest](https://docs.pytest.org/en/latest/) 8.3.4+
-   [pytest-mock](https://github.com/pytest-dev/pytest-mock/) 3.11.1+
-   [pytest-asyncio](https://github.com/pytest-dev/pytest-asyncio) 0.25.3+

## Instala√ß√£o

1.  Clone o reposit√≥rio:
    ```bash
    git clone https://github.com/seu-usuario/gym-nation-bot.git
    cd gym-nation-bot
    ```

2.  Instale as depend√™ncias:
    ```bash
    pip install -r requirements.txt
    ```

3.  Configure as vari√°veis de ambiente:
    -   Crie um arquivo `.env` na raiz do projeto baseado no `.env.example`.
    -   Preencha com suas chaves API, string de conex√£o do MongoDB e ID do propriet√°rio:
        ```
        TELEGRAM_API_TOKEN=seu_token_aqui
        ANTHROPIC_API_KEY=sua_chave_anthropic_aqui
        MONGODB_CONNECTION_STRING=sua_string_de_conexao_mongodb
        OWNER_ID=seu_id_do_telegram # Importante para permiss√µes
        BOT_USERNAME=Nations_bro_bot # Opcional, usado em algumas l√≥gicas
        ```
    -   Para obter seu ID do Telegram, envie uma mensagem para [@userinfobot](https://t.me/userinfobot).

## Uso

### M√©todo 1: Execu√ß√£o direta

Execute o bot a partir do diret√≥rio raiz:
```bash
python -m src.main
```

### M√©todo 2: Usando Docker

1.  Certifique-se de que o Docker e o Docker Compose estejam instalados.
2.  Inicie o MongoDB e o bot com Docker Compose:
    ```bash
    docker-compose up -d
    ```
3.  Para parar os servi√ßos:
    ```bash
    docker-compose down
    ```

## Controle de Acesso e Permiss√µes

O bot opera com um sistema de permiss√µes baseado em tr√™s n√≠veis:

1.  **Propriet√°rio do Bot:** Definido pela vari√°vel `OWNER_ID` no `.env`. Tem acesso total a todos os comandos e funcionalidades, incluindo o gerenciamento de administradores do bot.
2.  **Administradores do Bot:** Usu√°rios adicionados pelo propriet√°rio atrav√©s do comando `/setadmin`. Podem usar a maioria dos comandos de intera√ß√£o e modera√ß√£o em grupos onde o bot est√° presente e em chats privados com o bot.
3.  **Membros do Grupo:** Usu√°rios regulares nos grupos onde o bot est√°. Podem interagir com o bot principalmente atrav√©s do sistema de check-in e do assistente de d√∫vidas por men√ß√£o. A maioria dos comandos diretos √© ignorada.

**Importante:** Por padr√£o, o bot s√≥ responde a comandos enviados pelo Propriet√°rio ou Administradores do Bot, tanto em chats privados quanto em grupos. Mensagens de outros usu√°rios que tentam usar comandos s√£o silenciosamente ignoradas. A exce√ß√£o √© o Assistente de D√∫vidas Fitness, que pode ser ativado por qualquer membro ao mencionar o bot em resposta a uma pergunta.

## Comandos do Bot

### Comandos para Propriet√°rio e Administradores do Bot

Estes comandos podem ser usados pelo propriet√°rio e pelos administradores do bot em chats privados ou em grupos onde o bot est√°.

-   `/start` - Inicia a intera√ß√£o com o bot (em chat privado).
-   `/help` - Mostra a mensagem de ajuda com os comandos dispon√≠veis.
-   `/motivacao` - Envia uma mensagem de motiva√ß√£o fitness gerada por IA.
-   `/fecho` - Envia uma tirada sarc√°stica e debochada com humor.
-   `/apresentacao` - Responde com uma apresenta√ß√£o personalizada do bot.
-   `/macros <descri√ß√£o do alimento/refei√ß√£o>` - Calcula macronutrientes estimados para o item descrito.
-   `/regras` - Mostra as regras do grupo GYM NATION (se configuradas).
-   `/checkin` - (Respondendo a uma mensagem) Define a mensagem respondida como a √¢ncora de check-in ativa para o grupo.
-   `/endcheckin` - Desativa o check-in ativo no grupo.
-   `/checkinscore` - Mostra o ranking de check-ins dos usu√°rios no grupo.
-   `/confirmcheckin <user_id ou reply>` - Confirma manualmente o check-in para um usu√°rio espec√≠fico no check-in ativo.
-   `/addblacklist` - (Respondendo a uma mensagem) Adiciona a mensagem respondida √† blacklist do chat.
-   `/blacklist` - Lista as mensagens atualmente na blacklist do chat.
-   `/rmblacklist <id_da_mensagem_na_blacklist>` - Remove uma mensagem da blacklist usando seu ID √∫nico.
-   `/say <mensagem>` - Faz o bot enviar a mensagem especificada no chat atual.
-   `/sayrecurrent <intervalo> <mensagem>` - Configura uma mensagem recorrente. Intervalo (ex: `1d`, `2h30m`).
-   `/listrecurrent` - Lista as mensagens recorrentes configuradas para o chat.
-   `/delrecurrent <id_da_mensagem>` - Deleta uma mensagem recorrente pelo seu ID.

### Comandos Exclusivos do Propriet√°rio do Bot

Estes comandos s√≥ podem ser usados pelo usu√°rio definido como `OWNER_ID`.

-   `/setadmin <user_id ou reply> [Nome Opcional]` - Adiciona um usu√°rio como administrador do bot. Pode ser usado respondendo a uma mensagem do usu√°rio ou fornecendo o ID diretamente.
-   `/deladmin <user_id ou reply>` - Remove um usu√°rio da lista de administradores do bot.
-   `/listadmins` - Lista todos os administradores atuais do bot.
-   `/monitor` - (Em um grupo) Come√ßa a monitorar todas as mensagens enviadas no grupo (para fins de depura√ß√£o ou an√°lise).
-   `/unmonitor` - (Em um grupo) Para de monitorar as mensagens no grupo.

### Intera√ß√µes para Membros do Grupo

Membros regulares podem interagir com o bot das seguintes formas:

-   **Check-in:** Responder √† mensagem √¢ncora de check-in (definida por um admin/propriet√°rio) para registrar presen√ßa.
-   **Assistente de D√∫vidas Fitness:** Mencionar o bot (`@NomeDoBot`) em resposta a uma mensagem contendo uma d√∫vida sobre fitness para receber uma resposta gerada por IA.

## Funcionalidades Detalhadas

### Sistema de Check-in

1.  Um administrador ou propriet√°rio usa `/checkin` respondendo a uma mensagem no grupo. Essa mensagem se torna a "√¢ncora".
2.  Membros podem responder a essa mensagem √¢ncora (com qualquer texto/emoji) para fazer check-in.
3.  O bot reage √† resposta do membro para confirmar o check-in.
4.  `/checkinscore` mostra quem fez mais check-ins.
5.  `/endcheckin` desativa a √¢ncora atual.
6.  `/confirmcheckin` permite adicionar manualmente um check-in para um usu√°rio.

### Assistente de D√∫vidas Fitness por Men√ß√£o

1.  Um membro responde a uma mensagem com uma d√∫vida fitness mencionando o bot (ex: `@Nations_bro_bot`).
2.  O bot usa a API da Anthropic para analisar a pergunta e gerar uma resposta informativa.
3.  A resposta inclui bot√µes de feedback (üëç/üëé) e um bot√£o "Modo Especialista" para uma resposta mais detalhada via mensagem privada.
4.  H√° um limite di√°rio de consultas por usu√°rio.

### Sistema de Blacklist

-   Permite que propriet√°rio/admins adicionem mensagens espec√≠ficas (usando `/addblacklist` em resposta) a uma lista negra para um chat.
-   √ötil para marcar conte√∫do inadequado ou spam recorrente.
-   `/blacklist` lista as mensagens marcadas e `/rmblacklist` remove uma entrada pelo seu ID.

### Mensagens Recorrentes

-   Propriet√°rio/admins podem configurar mensagens para serem enviadas automaticamente em intervalos regulares (dias, horas, minutos) usando `/sayrecurrent`.
-   `/listrecurrent` mostra as mensagens agendadas e `/delrecurrent` permite remov√™-las.

## Testes

Execute os testes automatizados com:
```bash
pytest
```

## Estrutura do Projeto

```
bro-bot/
‚îú‚îÄ‚îÄ .env                      # Vari√°veis de ambiente (n√£o versionado)
‚îú‚îÄ‚îÄ .env.example              # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ .gitignore                # Arquivos ignorados pelo Git
‚îú‚îÄ‚îÄ README.md                 # Este arquivo
‚îú‚îÄ‚îÄ requirements.txt          # Depend√™ncias Python
‚îú‚îÄ‚îÄ docker-compose.yml        # Configura√ß√£o do Docker Compose
‚îú‚îÄ‚îÄ src/                      # C√≥digo fonte do bot
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py               # Ponto de entrada da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ bot/                  # L√≥gica espec√≠fica do bot (handlers, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers.py       # Handlers gerais de comandos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkin_handlers.py # L√≥gica do sistema de check-in
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mention_handlers.py # L√≥gica para responder a men√ß√µes (QA Fitness)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blacklist_handlers.py # L√≥gica do sistema de blacklist
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ messages.py       # Mensagens de texto usadas pelo bot
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ motivation.py     # Gera√ß√£o de mensagens motivacionais
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fitness_qa.py     # Intera√ß√£o com API Anthropic para QA
‚îÇ   ‚îî‚îÄ‚îÄ utils/                # Utilit√°rios e m√≥dulos de suporte
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ config.py         # Carregamento de configura√ß√µes (.env)
‚îÇ       ‚îú‚îÄ‚îÄ filters.py        # Filtros de mensagem personalizados (permiss√µes)
‚îÇ       ‚îú‚îÄ‚îÄ mongodb_client.py # Fun√ß√µes de intera√ß√£o com MongoDB
‚îÇ       ‚îú‚îÄ‚îÄ mongodb_instance.py # Inicializa√ß√£o da inst√¢ncia do cliente MongoDB
‚îÇ       ‚îú‚îÄ‚îÄ anthropic_client.py # Cliente para a API da Anthropic
‚îÇ       ‚îî‚îÄ‚îÄ recurring_messages_manager.py # Gerenciador de mensagens recorrentes
‚îú‚îÄ‚îÄ tests/                    # Testes automatizados (pytest)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_*.py             # Arquivos de teste para diferentes m√≥dulos
‚îÇ   ‚îî‚îÄ‚îÄ .pytest_cache/        # Cache do pytest
‚îú‚îÄ‚îÄ scripts/                  # Scripts auxiliares (manuten√ß√£o, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ check_recurring_messages.py
‚îÇ   ‚îú‚îÄ‚îÄ clean_recurring_messages.py
‚îÇ   ‚îú‚îÄ‚îÄ create_test_recurring_message.py
‚îÇ   ‚îú‚îÄ‚îÄ fix_db.py
‚îÇ   ‚îî‚îÄ‚îÄ check_db.py
‚îú‚îÄ‚îÄ docs/                     # Documenta√ß√£o adicional (se houver)
‚îú‚îÄ‚îÄ .git/                     # Metadados do Git
‚îî‚îÄ‚îÄ venv/                     # Ambiente virtual Python (n√£o versionado)
```

## Contribui√ß√£o

Contribui√ß√µes s√£o bem-vindas! Sinta-se √† vontade para abrir *issues* ou enviar *pull requests*. 